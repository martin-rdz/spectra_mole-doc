

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>spectra_mole &mdash; spectra_mole 0.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> spectra_mole
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_doc.html">api documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../params.html">Adjustable parameters</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">spectra_mole</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>spectra_mole</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for spectra_mole</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="c1"># coding=utf-8</span>

<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c1">#matplotlib.use(&#39;Agg&#39;)</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>

<span class="c1">#from numba import jit</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">helpers</span> <span class="k">as</span> <span class="n">h</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">recPeakFinder</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">vis</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">advection</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">attenuation</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">writer</span>
<span class="c1">#import viridis  # fancy new colormap</span>
<span class="c1">#import VIS_Colormaps  # vertical velocity color map</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">stream_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">stream_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(levelname)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">stream_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../test.log&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">-</span><span class="si">%(name)s</span><span class="s1">-</span><span class="si">%(levelname)s</span><span class="s1">-</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
<span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">stream_handler</span><span class="p">)</span>


<span class="n">mom2str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;Z:</span><span class="si">{0:.2f}</span><span class="s1"> v:</span><span class="si">{1:.2f}</span><span class="s1"> w:</span><span class="si">{2:.2f}</span><span class="s1"> snr:</span><span class="si">{5:.2f}</span><span class="s1"> | &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">mom</span><span class="p">)</span> <span class="k">for</span> <span class="n">mom</span> <span class="ow">in</span> <span class="n">l</span><span class="p">])</span>

<span class="n">flatten</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">flatten</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">l</span><span class="p">]</span>
<span class="n">peaks2vel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">vel</span><span class="p">,</span> <span class="n">peaks</span><span class="p">:</span> <span class="p">[(</span><span class="n">vel</span><span class="p">[</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">vel</span><span class="p">[</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>
<span class="n">vel2str</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">vel</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;(</span><span class="si">{:4.2f}</span><span class="s1"> </span><span class="si">{:4.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">vel</span><span class="p">]</span>


<div class="viewcode-block" id="peaks2snr"><a class="viewcode-back" href="../api_doc.html#spectra_mole.peaks2snr">[docs]</a><span class="k">def</span> <span class="nf">peaks2snr</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">peaks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the snr for each peak</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        noise (float): noise level</span>
<span class="sd">        z (1d-array): spectral reflectivity</span>
<span class="sd">        peaks (tupel or list of tupels): boundaries of the peaks</span>

<span class="sd">    Returns:</span>
<span class="sd">        SNR value of the peaks (or list of values)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">peaks</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;empty peak list&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">noise</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">noise</span><span class="p">))</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span></div>

<div class="viewcode-block" id="gauss_func"><a class="viewcode-back" href="../api_doc.html#spectra_mole.gauss_func">[docs]</a><span class="k">def</span> <span class="nf">gauss_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the gaussian function on a given grid</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array): grid</span>
<span class="sd">        m (float): mean</span>
<span class="sd">        sd (float): standard deviation</span>

<span class="sd">    Returns:</span>
<span class="sd">        array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">sd</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sd</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="check_consistency"><a class="viewcode-back" href="../api_doc.html#spectra_mole.check_consistency">[docs]</a><span class="k">def</span> <span class="nf">check_consistency</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        lst: list of spectra dictionaries</span>
<span class="sd">            (has to contain ``system``, ``ts``, ``range``)</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="c1">#timestamps = [&#39;{} {:.1f}&#39;.format(elem[&#39;system&#39;], elem[&#39;ts&#39;]) for elem in lst]</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---- consistency check ---------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;timestamps </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;heights    </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">heights</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">timediff</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">]</span>
        <span class="n">heightdiff</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;range&#39;</span><span class="p">]</span>
        <span class="c1"># 5.5sec is not enough as the cloud radar sometimes jumps more than 10s</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">timediff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;times differ too much: </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">]),</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ts&#39;</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">heightdiff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">40.</span><span class="p">,</span> <span class="s1">&#39;heights differ too much: </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">],</span>
                                                                                <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;system&#39;</span><span class="p">])</span></div>

<span class="c1">#@profile</span>
<div class="viewcode-block" id="broaden_spectrum"><a class="viewcode-back" href="../api_doc.html#spectra_mole.broaden_spectrum">[docs]</a><span class="k">def</span> <span class="nf">broaden_spectrum</span><span class="p">(</span><span class="n">adv_tupel</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">cut_thres</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        adv_tupel (tupel): advection velocity, shear, (u, v)</span>
<span class="sd">        spectrum (dict): The second parameter</span>
<span class="sd">        cut_thres (int, optional): mask values beow this threshold, else</span>
<span class="sd">            use the ``noise_thres`` in ``spectrum``</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict with broadened spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adv_vel</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">adv_tupel</span>

    <span class="n">half_bw</span> <span class="o">=</span> <span class="mf">0.0262</span>
    <span class="n">sigma_sq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">half_bw</span> <span class="o">*</span> <span class="n">adv_vel</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># \</span>
    <span class="c1"># + 3. / 24. * (half_bw * shear * self.wipro.nheight[1]) ** 2 \</span>
    <span class="c1"># + 1. / 36. * (half_bw * shear * self.wipro.delta_h) ** 2</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;delta v </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])))</span>
    <span class="n">sigma_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_sq</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sigma_b </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>

    <span class="n">specZ_filtered</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">specSNRco_filtered</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">plankton_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">13</span><span class="p">,</span> <span class="o">~</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked_mask&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2100</span><span class="p">:</span> 
        <span class="n">plankton_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span> 
            <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">13</span><span class="p">,</span> <span class="o">~</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked_mask&#39;</span><span class="p">])</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">plankton_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    
    <span class="n">specZ_filtered</span><span class="p">[</span><span class="n">plankton_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">3.</span>
    <span class="n">specSNRco_filtered</span><span class="p">[</span><span class="n">plankton_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">3.</span>
    <span class="n">specZbroad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">specZ_filtered</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>
    <span class="n">specSNRbroad</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">specSNRco_filtered</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">)</span>

    <span class="c1">#print(&quot;specLDRmasked &quot;, h.lin2z(spectrum[&#39;specLDRmasked&#39;][100:-100]))</span>
    <span class="c1">#print(&quot;specZ plankton filtered &quot;, h.lin2z(specZ_filtered[100:-100]))</span>

    <span class="n">spectrum_b</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">],</span> <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;noise_thres&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_broad&#39;</span><span class="p">}</span>
    <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specZbroad</span>
    <span class="k">if</span> <span class="n">cut_thres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specZbroad</span> <span class="o">&lt;</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cut_thres</span>
        <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specZbroad</span> <span class="o">&lt;</span> <span class="n">cut_thres</span>
        <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cut_thres</span><span class="o">/</span><span class="mf">3.</span>
    <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specSNRbroad</span>
    <span class="n">spectrum_b</span><span class="p">[</span><span class="s1">&#39;sigma_b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_b</span>
    <span class="k">return</span> <span class="n">spectrum_b</span></div>


<div class="viewcode-block" id="check_particle_influence"><a class="viewcode-back" href="../api_doc.html#spectra_mole.check_particle_influence">[docs]</a><span class="k">def</span> <span class="nf">check_particle_influence</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">noise_thres</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check if there is signal in the spectrum above the threshold</span>
<span class="sd">    internally a Q of 3 is assumed (noise_thres = 3*noise_lvl)</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum (dict): spectra dict</span>
<span class="sd">        noise_thres (float): the noise threshold</span>
<span class="sd">    Returns:</span>
<span class="sd">        bflag dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">noise_thres</span><span class="o">/</span><span class="mf">3.</span><span class="p">):</span>
        <span class="n">bflag</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;particle_influence&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bflag</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;particle_influence&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">bflag</span></div>

<span class="c1">#@profile</span>
<div class="viewcode-block" id="calc_moments"><a class="viewcode-back" href="../api_doc.html#spectra_mole.calc_moments">[docs]</a><span class="k">def</span> <span class="nf">calc_moments</span><span class="p">(</span><span class="n">spectrum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;estimate the moments for peaks above the noise threshold</span>
<span class="sd">    if no peak is found ``mom(-200, -99., -99., -1, -1, -200)``</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum (dict): spectra dict</span>
<span class="sd">    Returns:</span>
<span class="sd">        list of moments (namedtuple) in decending order</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">peak_list</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">detect_peak_simple</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">],</span> <span class="n">lthres</span><span class="o">=</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">])</span>
    <span class="n">moments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peak_list</span><span class="p">:</span>
        <span class="n">refl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="n">weights</span><span class="o">=</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
            <span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">vel</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> 
            <span class="n">weights</span><span class="o">=</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">))</span>
        <span class="n">moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">snr</span><span class="p">))</span>

    <span class="c1"># sort the moments list in descending order</span>
    <span class="n">moments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">moments</span><span class="p">:</span>
        <span class="c1"># no peaks were found</span>
        <span class="n">moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">200</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">moments</span></div>


<div class="viewcode-block" id="filter_moments"><a class="viewcode-back" href="../api_doc.html#spectra_mole.filter_moments">[docs]</a><span class="k">def</span> <span class="nf">filter_moments</span><span class="p">(</span><span class="n">moments</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">cr_iright</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;remove all moments that are left of v+sigma, width &lt; 0.08 and moment.iright &gt; cr_iright</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        moments: list of moments</span>
<span class="sd">        v: mean velocity of cloud radar</span>
<span class="sd">        sigma: width of cloud radar</span>
<span class="sd">        cr_iright: right edge of cloud radar</span>
<span class="sd">    Returns:</span>
<span class="sd">        list of filtered moments, bflag</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_moments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bflag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;removed_moments&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;at filter moments </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mom2str</span><span class="p">(</span><span class="n">moments</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">moments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">moment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">v</span> <span class="o">+</span> <span class="n">sigma</span> <span class="ow">and</span> <span class="n">moment</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.08</span> <span class="ow">and</span> <span class="n">moment</span><span class="o">.</span><span class="n">iright</span> <span class="o">&gt;</span> <span class="n">cr_iright</span><span class="p">:</span>
                <span class="n">new_moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moment</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_moments</span><span class="p">:</span>
            <span class="c1"># no peaks were found</span>
            <span class="n">new_moments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">200</span><span class="p">))</span>
        <span class="n">new_moments</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;removed_moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">new_moments</span><span class="p">,</span> <span class="n">bflag</span></div>

<span class="c1">#@profile</span>
<div class="viewcode-block" id="check_rwp_calibration"><a class="viewcode-back" href="../api_doc.html#spectra_mole.check_rwp_calibration">[docs]</a><span class="k">def</span> <span class="nf">check_rwp_calibration</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">,</span> <span class="n">spectrum_broad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check the rwp calibration by comparing with a broadened cloud radar spectrum</span>

<span class="sd">    based on different criteria it is decided if the calibration in trustworthy</span>
<span class="sd">    (``unsecure_calibration``) and correctable (``mod_calibration``)</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum_rwp (dict): spectra dict of the wind profiler</span>
<span class="sd">        spectrum_broad (dict): spectra dict of cloud radar </span>
<span class="sd">            adapted to rwp sampling characteristics</span>
<span class="sd">    Returns:</span>
<span class="sd">        bflag, -cal_corr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO take care with the sign</span>
    <span class="n">bflag</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">deltaZ</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])</span>
    <span class="n">deltaZ_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">],</span> <span class="n">spectrum_broad</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">])</span>
    <span class="n">deltaZ</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">deltaZ</span><span class="p">,</span> <span class="n">deltaZ_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># find the bounds of the particle peak</span>
    <span class="n">ind_particle_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">spectrum_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ind_particle_peak</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">bounds_particle_peak</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind_particle_peak</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds_particle_peak</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;bounds particle peak </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bounds_particle_peak</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;shape of valid deltaZ </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">deltaZ</span><span class="p">[</span><span class="o">~</span><span class="n">deltaZ_mask</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># print(&#39;deltaZ &#39;, deltaZ[bounds_particle_peak[0]:bounds_particle_peak[1]+1])</span>
    <span class="c1"># print(&#39;deltaZ_mask&#39;, deltaZ_mask[bounds_particle_peak[0]:bounds_particle_peak[1]+1])</span>
    <span class="c1"># any valid measurements in this range?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">deltaZ_mask</span><span class="p">[</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]]):</span>
        <span class="c1"># check the calibration at the minimum of deltaSNR</span>
        <span class="n">mdeltaZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(&#39;mdeltaZ &#39;, mdeltaZ, deltaZ[mdeltaZ-2:mdeltaZ+3])</span>
        <span class="c1"># check the calibration at the maximum of the cloud radar peak</span>
        <span class="n">maxmiraZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">spectrum_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># print(&#39;maxmiraZ &#39;, maxmiraZ, deltaZ[maxmiraZ-2:maxmiraZ+3])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdeltaZ</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxmiraZ</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">mdeltaZ</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">maxmiraZ</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check calibration: no particle signal&#39;</span><span class="p">)</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;mod_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;unsecure_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cal_corr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">mdeltaZ</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">mdeltaZ</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> \
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">maxmiraZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">maxmiraZ</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check calibration: calibration ok&#39;</span><span class="p">)</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;mod_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;unsecure_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cal_corr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check calibration: needs correction&#39;</span><span class="p">)</span>
        <span class="c1"># weight differently</span>
        <span class="n">cal_corr</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">mdeltaZ</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">mdeltaZ</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">cal_corr</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">deltaZ</span><span class="p">[</span><span class="n">maxmiraZ</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">maxmiraZ</span><span class="o">+</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">cal_corr</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">cal_corr</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>

        <span class="n">deltaZ_part_filled</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span>
            <span class="n">deltaZ</span><span class="p">,</span> <span class="n">deltaZ_mask</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)[</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bounds_particle_peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stat_full_deltaZ</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">deltaZ_part_filled</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">cal_corr</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="n">stat_full_deltaZ</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;correct calibration by: </span><span class="si">%s</span><span class="s1"> statistics </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cal_corr</span><span class="p">,</span> <span class="n">stat_full_deltaZ</span><span class="p">)</span>
            <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;mod_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;unsecure_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calibration too much off: </span><span class="si">%s</span><span class="s1"> statistics </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cal_corr</span><span class="p">,</span> <span class="n">stat_full_deltaZ</span><span class="p">)</span>
            <span class="n">cal_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;mod_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;unsecure_calibration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">bflag</span><span class="p">,</span> <span class="o">-</span><span class="n">cal_corr</span></div>


<div class="viewcode-block" id="check_noise_level"><a class="viewcode-back" href="../api_doc.html#spectra_mole.check_noise_level">[docs]</a><span class="k">def</span> <span class="nf">check_noise_level</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">,</span> <span class="n">extern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    check if the Hildebrand-Sekhon noise ``noise_lvl_hs`` is more than 4dB above the noise </span>
<span class="sd">    provided by the standard signal processing</span>
<span class="sd">    if yes replace the noise information in the spectrum_rwp</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum (dict): spectra dict</span>
<span class="sd">        extern (optinal): additional noise threshold</span>
<span class="sd">    Returns:</span>
<span class="sd">        spectrum_rwp, bflag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">bflag</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;noise estimation wrong </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">]),</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]))</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;hs_higher_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">]</span>
        <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;hs_higher_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">extern</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">extern</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;external noise higher </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">extern</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]))</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;cr_higher_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extern</span><span class="o">/</span><span class="mf">3.</span>
        <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extern</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;cr_higher_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">return</span> <span class="n">spectrum_rwp</span><span class="p">,</span> <span class="n">bflag</span></div>

<span class="c1">#@profile</span>
<div class="viewcode-block" id="estimate_calibration"><a class="viewcode-back" href="../api_doc.html#spectra_mole.estimate_calibration">[docs]</a><span class="k">def</span> <span class="nf">estimate_calibration</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">,</span> <span class="n">spectrum_broad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;estimate the calibration constant in the interval -3.00 -0.7 m/s</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum_rwp (dict): spectra dict of the wind profiler</span>
<span class="sd">        spectrum_broad (dict): spectra dict of cloud radar </span>
<span class="sd">            adapted to rwp sampling characteristics</span>
<span class="sd">    Returns:</span>
<span class="sd">        cal_const or ``np.nan`` if no signal in this interval</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ivl</span><span class="p">,</span> <span class="n">ivr</span> <span class="o">=</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">118</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">ivl</span><span class="p">]</span> <span class="o">-</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">][</span><span class="n">ivr</span><span class="p">]</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">spectrum_broad</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">][</span><span class="n">ivl</span><span class="p">:</span><span class="n">ivr</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spec_calibration</span> <span class="o">=</span> <span class="n">spectrum_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">ivl</span><span class="p">:</span><span class="n">ivr</span><span class="p">]</span> <span class="o">/</span> \
                <span class="p">((</span><span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">spectrum_rwp</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">][</span><span class="n">ivl</span><span class="p">:</span><span class="n">ivr</span><span class="p">])</span>
        <span class="n">cal_const</span> <span class="o">=</span> <span class="n">spec_calibration</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cal_const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">cal_const</span></div>


<div class="viewcode-block" id="modify_calibration"><a class="viewcode-back" href="../api_doc.html#spectra_mole.modify_calibration">[docs]</a><span class="k">def</span> <span class="nf">modify_calibration</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">correction_factor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; update the calibration constant with a correction factor</span>
<span class="sd">    and calculate a new reflectivity spectrum from the SNR</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        spectrum_rwp (dict): spectra dict</span>
<span class="sd">        correction_factor (float): </span>
<span class="sd">    Returns:</span>
<span class="sd">        modified spectrum dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">correction_factor</span><span class="p">),</span> <span class="s1">&#39;correction factor is not valid&#39;</span>
    <span class="n">spectrum_mod</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cal_const </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">],</span> <span class="n">correction_factor</span><span class="p">)</span>
    <span class="n">cal_const</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">correction_factor</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cal_const new </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cal_const</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;old lvl </span><span class="si">%s</span><span class="s1"> thres </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]),</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]))</span>
    <span class="n">lin_correction_factor</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">correction_factor</span><span class="p">)</span> <span class="k">if</span> <span class="n">correction_factor</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">noise_thres</span> <span class="o">=</span> <span class="n">lin_correction_factor</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span>
    <span class="n">noise_lvl</span> <span class="o">=</span> <span class="n">lin_correction_factor</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]</span>
    <span class="n">noise_lvl_hs</span> <span class="o">=</span> <span class="n">lin_correction_factor</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new lvl </span><span class="si">%s</span><span class="s1"> thres </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">noise_lvl</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">noise_thres</span><span class="p">))</span>
    <span class="n">zspectrum</span> <span class="o">=</span> <span class="n">cal_const</span> <span class="o">*</span> <span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span>

    <span class="n">spectrum_mod</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zspectrum</span> <span class="o">&lt;</span> <span class="n">noise_thres</span>
    <span class="n">spectrum_mod</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zspectrum</span>
    <span class="n">spectrum_mod</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_thres</span>
    <span class="n">spectrum_mod</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_lvl</span>
    <span class="n">spectrum_mod</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_lvl_hs</span>
    <span class="n">spectrum_mod</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal_const</span>

    <span class="k">return</span> <span class="n">spectrum_mod</span></div>


<span class="c1">#@profile</span>
<div class="viewcode-block" id="correct_with_weighting"><a class="viewcode-back" href="../api_doc.html#spectra_mole.correct_with_weighting">[docs]</a><span class="k">def</span> <span class="nf">correct_with_weighting</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the corrected spectrum with the weighting functions</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum_rwp (dict): spectra dict of the wind profiler</span>
<span class="sd">        spectrum_broad (dict): spectra dict of cloud radar </span>
<span class="sd">            adapted to rwp sampling characteristics</span>
<span class="sd">    Returns:</span>
<span class="sd">        Bragg only spectrum dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wipro_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])</span>
    <span class="n">wipro_zspec_temp</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">],</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">],</span> <span class="n">wipro_min</span><span class="p">)</span>
    <span class="n">blured</span> <span class="o">=</span> <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span>
    <span class="n">deltaSNR</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">wipro_min</span><span class="p">)</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">blured</span><span class="o">/</span><span class="n">wipro_min</span><span class="p">)</span>
    <span class="c1"># find the bounds of the particle peak</span>
    <span class="n">ind_particle_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">blured</span> <span class="o">&gt;</span> <span class="n">wipro_min</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_particle_peak</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">bounds_particle_peak</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind_particle_peak</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds_particle_peak</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">rel</span> <span class="o">=</span> <span class="n">blured</span> <span class="o">/</span> <span class="n">wipro_zspec_temp</span>
    <span class="n">snr_cr</span> <span class="o">=</span> <span class="n">blured</span> <span class="o">/</span> <span class="n">wipro_min</span>
    <span class="c1"># allow only values &lt; 1</span>
    <span class="c1"># rel[rel &gt; 1] = rel[rel &gt; 1]**(-1)</span>
    <span class="n">rel1m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rel</span>
    <span class="n">weight_bragg</span> <span class="o">=</span> <span class="n">rel1m</span>
    <span class="c1"># where cloud radar reaches noise level, set equal 1</span>
    <span class="n">weight_bragg</span><span class="p">[</span><span class="n">blured</span> <span class="o">==</span> <span class="n">wipro_min</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># running mean on the weight</span>
    <span class="n">convol_kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">convol_kernel</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">convol_kernel</span><span class="p">)</span>
    <span class="n">weight_bragg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">weight_bragg</span><span class="p">,</span> <span class="n">convol_kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

    <span class="c1"># supress every signal where weight of bragg is less than 0.4</span>
    <span class="c1">#weight_bragg[weight_bragg &lt; 0.7] = snr_cr[weight_bragg &lt; 0.7] ** (-1)</span>
    <span class="c1"># 0.3 prooved to be too less....</span>
    <span class="n">weight_bragg</span><span class="p">[</span><span class="n">weight_bragg</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">]</span> <span class="o">=</span> <span class="n">snr_cr</span><span class="p">[</span><span class="n">weight_bragg</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># define something like a transition region</span>

    <span class="n">difference</span> <span class="o">=</span> <span class="n">wipro_zspec_temp</span> <span class="o">*</span> <span class="n">weight_bragg</span>

    <span class="n">spec_corr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">],</span> <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;rwp_corr&#39;</span><span class="p">,</span>
        <span class="s1">&#39;specZ&#39;</span><span class="p">:</span> <span class="n">difference</span><span class="p">,</span>
        <span class="s1">&#39;specZ_mask&#39;</span><span class="p">:</span> <span class="n">difference</span> <span class="o">&lt;</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span>
        <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="s1">&#39;delta_v&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">],</span> <span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">],</span>
        <span class="s1">&#39;noise_lvl&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">],</span> <span class="s1">&#39;noise_thres&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">spec_corr</span></div>

<span class="c1">#@profile</span>
<div class="viewcode-block" id="correct_with_fuzzy"><a class="viewcode-back" href="../api_doc.html#spectra_mole.correct_with_fuzzy">[docs]</a><span class="k">def</span> <span class="nf">correct_with_fuzzy</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the corrected spectrum with fuzzy membership</span>
<span class="sd">    for later application of the fitting </span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum_rwp (dict): spectra dict of the wind profiler</span>
<span class="sd">        spectrum_broad (dict): spectra dict of cloud radar </span>
<span class="sd">            adapted to rwp sampling characteristics</span>
<span class="sd">    Returns:</span>
<span class="sd">        Bragg only spectrum dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wipro_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])</span>
    <span class="n">wipro_zspec_temp</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">],</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">],</span> <span class="n">wipro_min</span><span class="p">)</span>

    <span class="n">wipro_zspec_temp</span><span class="p">[</span><span class="n">wipro_zspec_temp</span> <span class="o">&lt;</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">2.75</span><span class="o">/</span><span class="mf">2.9</span><span class="p">)]</span> <span class="o">=</span> <span class="n">wipro_min</span>
    <span class="n">blured</span> <span class="o">=</span> <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span>

    <span class="c1"># find the bounds of the particle peak</span>
    <span class="n">ind_particle_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">blured</span> <span class="o">&gt;</span> <span class="n">wipro_min</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ind_particle_peak</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">bounds_particle_peak</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind_particle_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind_particle_peak</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds_particle_peak</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1">#print(&#39;calc_fuzzy_spec: deltaSNR &#39;, deltaSNR[bounds_particle_peak[0]:bounds_particle_peak[1]+1])</span>
    <span class="c1"># range to scale the spectral reflectivity</span>
    <span class="n">values_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">wipro_min</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">blured</span><span class="p">))</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">fuzzy_cloudradar</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">blured</span><span class="p">)</span><span class="o">-</span><span class="n">values_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">values_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">values_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fuzzy_rwp</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">wipro_zspec_temp</span><span class="p">)</span> <span class="o">-</span> <span class="n">values_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">values_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">values_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fuzzy_rwp</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">fuzzy_rwp</span><span class="p">[</span><span class="mi">200</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># calculate a fuzzy mask</span>
    <span class="c1"># correlation of high return of both radars</span>
    <span class="c1"># vs anticorrelation high return of rwp and low return of cloud radar</span>
    <span class="n">fuzzy_bragg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fuzzy_cloudradar</span><span class="p">)</span><span class="o">*</span><span class="n">fuzzy_rwp</span>
    <span class="n">fuzzy_bragg</span><span class="p">[</span><span class="n">fuzzy_bragg</span> <span class="o">&lt;</span> <span class="n">fuzzy_cloudradar</span><span class="o">*</span><span class="n">fuzzy_rwp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># dump everything left of the intercepting point</span>
    <span class="n">fuzzy_bragg</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">blured</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">fuzzy_bragg</span><span class="p">[</span><span class="n">fuzzy_bragg</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1">#left edge of the co correlation</span>
    <span class="c1">#only used for logging, not for correction</span>
    <span class="n">leftedgecocorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">fuzzy_bragg</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fuzzy_bragg</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># and the fuzzy membership for larger than the cloud radar</span>
    <span class="n">fuzzy_bragg2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fuzzy_cloudradar</span><span class="p">)</span><span class="o">*</span><span class="n">fuzzy_rwp</span>
    <span class="n">fuzzy_bragg2</span><span class="p">[</span><span class="n">fuzzy_bragg2</span> <span class="o">&lt;</span> <span class="n">fuzzy_cloudradar</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">fuzzy_bragg2</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">blured</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">fuzzy_bragg2</span><span class="p">[</span><span class="n">fuzzy_bragg2</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">leftedgecr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">fuzzy_bragg2</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fuzzy_bragg2</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># minimum peak width</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fuzzy_bragg</span> <span class="o">&gt;</span> <span class="n">fuzzy_cloudradar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set fuzzy bragg to 0, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fuzzy_bragg</span> <span class="o">&gt;</span> <span class="n">fuzzy_cloudradar</span><span class="p">))</span>
        <span class="n">fuzzy_bragg</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># # test for now</span>
    <span class="c1">#peaks_fuzzy_bragg = h.detect_peak_simple(fuzzy_bragg, lthres=0.05)</span>
    <span class="c1">#print(&#39;peaks_fuzzy_bragg &#39;, peaks_fuzzy_bragg, leftedgecr)</span>
    <span class="c1"># filter out everything solely under cloud radar</span>
    <span class="c1">#peaks_fuzzy_bragg = filter(lambda x: x[1] &gt; leftedgecr+2, peaks_fuzzy_bragg)</span>
    <span class="n">peaks_fuzzy_bragg</span> <span class="o">=</span> <span class="n">recPeakFinder</span><span class="o">.</span><span class="n">detect_peak_recursive</span><span class="p">(</span><span class="n">fuzzy_bragg</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">thres</span><span class="p">:</span> <span class="n">thres</span><span class="o">+</span><span class="mf">0.1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="n">wipro_zspec_temp</span>
    <span class="n">difference</span><span class="p">[</span><span class="n">fuzzy_bragg</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wipro_min</span>

    <span class="n">peaks_wipro</span> <span class="o">=</span> <span class="n">recPeakFinder</span><span class="o">.</span><span class="n">detect_peak_recursive</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">],</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">thres</span><span class="p">:</span> <span class="n">thres</span><span class="o">*</span><span class="mf">1.4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">wipro_snr_wrapper</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">zspectrum</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">peaks</span><span class="p">:</span> <span class="n">peaks2snr</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">zspectrum</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>
    <span class="n">wipro_snr</span> <span class="o">=</span> <span class="n">wipro_snr_wrapper</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])</span>

    <span class="c1"># if there is a peak within the fuzzy, then restrict to that</span>
    <span class="k">if</span> <span class="n">peaks_fuzzy_bragg</span> <span class="ow">and</span> <span class="n">peaks_wipro</span><span class="p">:</span> <span class="c1"># ie list not empty</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=====    fuzzy peak decision =================================================&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;peaks_fuzz_bragg recursive </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">peaks_fuzzy_bragg</span><span class="p">,</span> <span class="n">leftedgecocorr</span><span class="p">,</span> <span class="n">leftedgecr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;peaks fuzzy snr </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wipro_snr</span><span class="p">(</span><span class="n">peaks_fuzzy_bragg</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;complete snr fuzzy </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">wipro_snr</span><span class="p">((</span><span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])),</span>
              <span class="n">wipro_snr</span><span class="p">((</span><span class="n">leftedgecr</span><span class="p">,</span> <span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;peaks wipro from recursive </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">peaks_wipro</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;velocities wipro </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vel2str</span><span class="p">(</span><span class="n">peaks2vel</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">peaks_wipro</span><span class="p">))))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;peaks wipro snr </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">wipro_snr</span><span class="p">(</span><span class="n">peaks_wipro</span><span class="p">))</span>
        <span class="n">peaks_filtered</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">peak</span><span class="p">:</span> <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">leftedgecr</span><span class="o">+</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">leftedgecr</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">wipro_snr</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">peaks_wipro</span><span class="p">))</span>

        <span class="c1">#print(&quot;peaks completely right of cr &quot;, peaks_filtered)</span>
        <span class="k">if</span> <span class="n">peaks_filtered</span> <span class="ow">and</span> <span class="n">wipro_snr</span><span class="p">((</span><span class="n">peaks_filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">peaks_filtered</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> \
                <span class="o">&lt;</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">wipro_snr</span><span class="p">((</span><span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])):</span>
            <span class="c1"># somehow lossed a very big peak</span>
            <span class="n">peaks_filtered</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">peak</span><span class="p">:</span> <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">leftedgecr</span><span class="o">+</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">wipro_snr</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">peaks_wipro</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">peaks_filtered</span><span class="p">:</span>
                <span class="n">peaks_filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">leftedgecr</span><span class="p">,</span> <span class="n">peaks_filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># hack for the 2015-08-27 case at 0514</span>
                <span class="n">peaks_filtered</span> <span class="o">=</span> <span class="p">[(</span><span class="n">leftedgecr</span><span class="p">,</span> <span class="n">peaks_wipro</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;after snr cond </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">peaks_filtered</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">filter_within</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">peak</span><span class="p">:</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">7</span> <span class="o">&lt;=</span> <span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                 <span class="ow">and</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                 <span class="ow">and</span> <span class="n">wipro_snr</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">peaks_wipro_within</span> <span class="o">=</span> <span class="p">[</span><span class="n">wp</span> <span class="k">for</span> <span class="n">wp</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">peaks_wipro</span><span class="p">,</span> <span class="n">peaks_fuzzy_bragg</span><span class="p">)</span> <span class="k">if</span>
                              <span class="n">filter_within</span><span class="p">(</span><span class="n">fp</span><span class="p">)(</span><span class="n">wp</span><span class="p">)]</span>
        <span class="c1">#print(&#39;peaks_wipro_within&#39;, peaks_wipro_within)</span>
        <span class="n">peaks_wipro_within_strict</span> <span class="o">=</span>  <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">leftedgecr</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">leftedgecr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">peaks_wipro_within</span><span class="p">))</span>
        <span class="c1">#print(&#39;peaks_wipro_within_strict&#39;, peaks_wipro_within_strict)</span>

        <span class="k">if</span> <span class="n">peaks_filtered</span><span class="p">:</span> <span class="c1"># ie list not empty</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use peaks filtered </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">peaks_filtered</span><span class="p">)</span>
            <span class="n">difference</span><span class="p">[:</span><span class="n">peaks_filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wipro_min</span>
            <span class="n">difference</span><span class="p">[</span><span class="n">peaks_filtered</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">wipro_min</span>
        <span class="k">elif</span> <span class="n">peaks_wipro_within_strict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use peaks_wipro_within_strict </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">peaks_wipro_within_strict</span><span class="p">)</span>
            <span class="n">difference</span><span class="p">[:</span><span class="n">peaks_wipro_within_strict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wipro_min</span>
            <span class="n">difference</span><span class="p">[</span><span class="n">peaks_wipro_within_strict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">wipro_min</span>
        <span class="k">elif</span> <span class="n">peaks_wipro_within</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use peaks_wipro_within </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">peaks_wipro_within</span><span class="p">)</span>
            <span class="n">difference</span><span class="p">[:</span><span class="n">peaks_wipro_within</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wipro_min</span>
            <span class="n">difference</span><span class="p">[</span><span class="n">peaks_wipro_within</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">wipro_min</span>
        <span class="c1">#elif wipro_snr((peaks_fuzzy_bragg[0][0], peaks_fuzzy_bragg[-1][1])) &gt; 15.:</span>
        <span class="k">elif</span> <span class="n">wipro_snr</span><span class="p">((</span><span class="n">leftedgecr</span><span class="p">,</span> <span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">15.</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use snr between leftedge and fuzzy bragg&quot;</span><span class="p">)</span>
            <span class="n">difference</span><span class="p">[:</span><span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wipro_min</span>
            <span class="n">difference</span><span class="p">[</span><span class="n">peaks_fuzzy_bragg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">=</span> <span class="n">wipro_min</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">difference</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">wipro_min</span>


    <span class="k">if</span> <span class="n">savepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">clara_pix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vel_list&#39;</span><span class="p">],</span> <span class="n">fuzzy_cloudradar</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;raw cloud&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">clara_pix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vel_list&#39;</span><span class="p">],</span> <span class="n">fuzzy_rwp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;raw RWP&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SNR spec at &quot;</span> <span class="o">+</span> <span class="n">ts_to_dt</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H%M&quot;</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:4d}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">])),</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="c1">#ax[0].set_xlim([-4.0, 1.5])</span>


        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">clara_pix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vel_list&#39;</span><span class="p">],</span> <span class="n">fuzzy_cloudradar</span><span class="o">*</span><span class="n">fuzzy_rwp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;co&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">clara_pix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vel_list&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fuzzy_cloudradar</span><span class="p">)</span><span class="o">*</span><span class="n">fuzzy_rwp</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;cross&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">clara_pix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vel_list&#39;</span><span class="p">],</span> <span class="n">fuzzy_cloudradar</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">clara_pix</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;vel_list&#39;</span><span class="p">],</span> <span class="n">fuzzy_bragg</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Bragg&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="c1">#ax[1].set_xlim([-4.0, 1.5])</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
            <span class="c1">#a.set_ylim([0, 1])</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
            <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
            <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Weight&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Velocity [m s$</span><span class="se">\\</span><span class="s2">mathregular{^{-1}}$]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;fuzzy membership &quot;</span> <span class="o">+</span> <span class="n">ts_to_dt</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H%M&quot;</span><span class="p">)</span> <span class="o">+</span>
                     <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:4d}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">])),</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">savename</span> <span class="o">=</span> <span class="n">savepath</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">ts_to_dt</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> \
                   <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0:04d}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s2">&quot;_fuzzy_membership_transform.png&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span>
        <span class="n">savename</span> <span class="o">=</span> <span class="n">savepath</span> <span class="o">+</span> <span class="s2">&quot;/svg/&quot;</span> <span class="o">+</span> <span class="n">ts_to_dt</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H%M&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> \
                   <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{0:04d}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="s2">&quot;_fuzzy_membership_transform.svg&quot;</span>
        <span class="c1">#fig.savefig(savename)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>


    <span class="c1"># data_dict = {&#39;sel_height&#39;: wipro_pix.data[&#39;sel_height&#39;], &#39;sel_timestamp&#39;: wipro_pix.data[&#39;sel_timestamp&#39;],</span>
    <span class="c1">#              &#39;ntime&#39;: wipro_pix.data[&#39;ntime&#39;], &#39;nheight&#39;: wipro_pix.data[&#39;nheight&#39;],</span>
    <span class="c1">#              &#39;noise_lvl&#39;: wipro_pix.data[&#39;noise_lvl&#39;], &#39;delta_v&#39;: wipro_pix.data[&#39;delta_v&#39;],</span>
    <span class="c1">#              &#39;noise_thres&#39;: wipro_pix.data[&#39;noise_thres&#39;],</span>
    <span class="c1">#              &#39;zspectrum&#39;: difference, &#39;fuzzy_membership&#39;: fuzzy_bragg,</span>
    <span class="c1">#              &#39;vel_list&#39;: clara_pix.data[&#39;vel_list&#39;], &#39;instr&#39;: &#39;corr&#39;}</span>

    <span class="n">spec_corr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">],</span> <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;rwp_corr&#39;</span><span class="p">,</span>
        <span class="s1">&#39;specZ&#39;</span><span class="p">:</span> <span class="n">difference</span><span class="p">,</span>
        <span class="s1">&#39;fuzzy_membership&#39;</span><span class="p">:</span> <span class="n">fuzzy_bragg</span><span class="p">,</span>
        <span class="s1">&#39;specZ_mask&#39;</span><span class="p">:</span> <span class="n">difference</span> <span class="o">&lt;</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span>
        <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="s1">&#39;delta_v&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">],</span> <span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">],</span>
        <span class="s1">&#39;noise_lvl&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">],</span> <span class="s1">&#39;noise_thres&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">spec_corr</span></div>


<div class="viewcode-block" id="fit_res_curve"><a class="viewcode-back" href="../api_doc.html#spectra_mole.fit_res_curve">[docs]</a><span class="k">def</span> <span class="nf">fit_res_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">sd1</span><span class="p">,</span> <span class="n">s1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;function that calculates the fit residuals</span>
<span class="sd">    http://stackoverflow.com/questions/10143905/python-two-curve-gaussian-fitting-with-non-linear-least-squares</span>

<span class="sd">    Args:</span>
<span class="sd">        x: grid</span>
<span class="sd">        m1: center of the gaussian</span>
<span class="sd">        sd1: standard deviation of the gaussian</span>
<span class="sd">        s1: scale value for the gaussian (here full reflectivity)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">*</span> <span class="n">gauss_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">sd1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_fit</span></div>

<span class="c1">#@profile</span>
<div class="viewcode-block" id="fit_peak"><a class="viewcode-back" href="../api_doc.html#spectra_mole.fit_peak">[docs]</a><span class="k">def</span> <span class="nf">fit_peak</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">,</span> <span class="n">moments</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fit one peak to the fuzzy membership filtered spectrum</span>

<span class="sd">    Args:</span>
<span class="sd">        spectrum_corr (dict): Bragg only spectrum</span>
<span class="sd">        moments (list of mom): list of the moments for this spectrum</span>
<span class="sd">    Returns:</span>
<span class="sd">        Bragg only spectrum dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;=====    fit peak =================================================&#39;</span><span class="p">)</span>
    <span class="c1"># fit is stronger constrained if peak with highest reflectivity is </span>
    <span class="c1"># below -25 dBZ</span>
    <span class="k">if</span> <span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">25.</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="o">==</span> <span class="o">-</span><span class="mi">200</span> <span class="ow">or</span> <span class="n">moments</span> <span class="o">==</span> <span class="p">[]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;# moments fuzzy spec_corr (used for fit) </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">moments</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">),</span> <span class="mf">0.45</span><span class="p">)</span>
        <span class="n">refl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">refl</span><span class="p">)</span><span class="o">*</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.07</span><span class="p">,</span><span class="n">width</span><span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="o">-</span><span class="mf">55.</span><span class="p">)</span><span class="o">*</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]],</span>
                  <span class="p">[</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">+</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span><span class="o">*</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="o">-</span><span class="mf">20.</span><span class="p">)</span><span class="o">*</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="o">-</span><span class="mf">60.</span><span class="p">)</span><span class="o">*</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span><span class="o">*</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;p  </span><span class="si">%s</span><span class="s1">  bounds </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>

    <span class="n">spec_to_fit</span> <span class="o">=</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">spec_to_fit</span><span class="p">[</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1e-100</span>
    <span class="c1">#spec_to_fit -= wipro_pix.data[&#39;noise_thres&#39;]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;# refl at fit </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">])),</span>
          <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spec_to_fit</span><span class="p">)))</span>
    <span class="n">moments_fit</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">param_lsq</span><span class="p">,</span> <span class="n">cov_lsq</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_res_curve</span><span class="p">,</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">spec_to_fit</span><span class="p">,</span>
                                       <span class="n">p0</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">err_lsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_lsq</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;param lsq (single peak) </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">param_lsq</span><span class="p">,</span> <span class="n">err_lsq</span><span class="p">)</span>

        <span class="n">fitted_spectrum</span> <span class="o">=</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">gauss_func</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">fitted_spectrum</span> <span class="o">&gt;</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">ileft</span><span class="p">,</span> <span class="n">iright</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ileft</span><span class="p">,</span> <span class="n">iright</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">moments_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fitted_spectrum</span> <span class="o">-</span> <span class="mf">1e-100</span><span class="p">)),</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">ileft</span><span class="p">,</span> <span class="n">iright</span><span class="p">,</span> 
                <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fitted_spectrum</span> <span class="o">-</span> <span class="mf">1e-100</span><span class="p">)</span><span class="o">/</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3.</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;moments from fit </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">param_lsq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">]),</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param_lsq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fitted_spectrum</span> <span class="o">-</span> <span class="mf">1e-100</span><span class="p">)))])</span>

    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;# not enough rayleigh signal&#39;</span><span class="p">)</span>
        <span class="n">moments_fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">200</span><span class="p">)]</span>
        <span class="n">fitted_spectrum</span> <span class="o">=</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fitted_spectrum</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1e-20</span>
        <span class="n">err_lsq</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">99.</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">moments_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mf">0.07</span> \
            <span class="ow">or</span> <span class="n">moments_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">50</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">moments_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span><span class="p">):</span>
        <span class="c1"># fitted peak too small (testcase eg 2015-06-17_2130 8014)</span>
        <span class="n">moments_fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">200</span><span class="p">)]</span>
        <span class="c1"># for the moment do not overwrite if it fails</span>
        <span class="c1">#fitted_spectrum = spec_corr[&#39;specZ&#39;].copy()</span>
        <span class="c1">#fitted_spectrum[:] = 1e-20</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">moments_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="o">-</span><span class="mf">0.2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.15</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">moments_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="c1"># fit somehow failed</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;moment fit replicated input&#39;</span><span class="p">)</span>
        <span class="n">moments_fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">mom</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">200</span><span class="p">)]</span>

    <span class="c1"># if np.abs(moments_fit[0].width-p[1]) &lt; 0.15 and np.abs(moments_fit[0].v-p[1]) &lt; 0.01:</span>
    <span class="c1">#     # fit somehow failed</span>
    <span class="c1">#     print(&#39;moment fit replicated input&#39;)</span>
    <span class="c1">#     moments_fit = [h.mom(-200, -99., -99., -1, -1, -200)]</span>

    <span class="n">spec_corr</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">],</span> <span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;fit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;specZ&#39;</span><span class="p">:</span> <span class="n">fitted_spectrum</span><span class="p">,</span>
        <span class="s1">&#39;apriori_spec&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">],</span>
        <span class="s1">&#39;specZ_mask&#39;</span><span class="p">:</span> <span class="n">fitted_spectrum</span> <span class="o">&lt;</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span>
        <span class="s1">&#39;err_fit&#39;</span><span class="p">:</span> <span class="n">err_lsq</span><span class="p">,</span>
        <span class="s1">&#39;moments&#39;</span><span class="p">:</span> <span class="n">moments_fit</span><span class="p">,</span>
        <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">],</span> <span class="s1">&#39;delta_v&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;delta_v&#39;</span><span class="p">],</span> <span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">],</span>
        <span class="s1">&#39;noise_lvl&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">],</span> <span class="s1">&#39;noise_thres&#39;</span><span class="p">:</span> <span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">spec_corr</span></div>


<div class="viewcode-block" id="estimate_flag"><a class="viewcode-back" href="../api_doc.html#spectra_mole.estimate_flag">[docs]</a><span class="k">def</span> <span class="nf">estimate_flag</span><span class="p">(</span><span class="n">bflag</span><span class="p">,</span> <span class="n">corr_moments</span><span class="p">,</span> <span class="n">cr_moments</span><span class="p">,</span> <span class="n">cr_ldr</span><span class="p">,</span> <span class="n">bounds_unfiltered_moments</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;retrieve the integer flag from the binary flag</span>

<span class="sd">    the available integer flags are:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {0: &#39;not influenced&#39;, 1: &#39;hydromet only&#39;,</span>
<span class="sd">         2: &#39;plankton&#39;, 3: &#39;low snr&#39;,</span>
<span class="sd">         4: &#39;&#39;, 5: &#39;melting layer&#39;}</span>

<span class="sd">    Args:</span>
<span class="sd">        bflag (dict): binary flag dict</span>
<span class="sd">        corr_moments (list): list with the corrected moments</span>
<span class="sd">        cr_moments (list): list with the cloud radar moemnts</span>
<span class="sd">        cr_ldr (float): cloud radar ldr in dB</span>
<span class="sd">        bounds_unfiltered_moments (list): all peak boundaries</span>
<span class="sd">    Returns:</span>
<span class="sd">        add_to_binary_flag, flag, flag_doc</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># do not overwrite bflag here! (this has to be done at top level)</span>
    <span class="n">addbflag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low_snr&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                <span class="s1">&#39;plankton&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;melting_layer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">flag_doc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;not influenced&#39;</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;hydromet only&#39;</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;plankton&#39;</span><span class="p">,</span>
                <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;low snr&#39;</span><span class="p">,</span>
                <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;melting layer&#39;</span><span class="p">}</span>

    <span class="n">bins_above_noise</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds_unfiltered_moments</span><span class="p">])</span>
    <span class="n">bounds_unfiltered_moments</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">bin_max_span</span> <span class="o">=</span> <span class="n">bounds_unfiltered_moments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds_unfiltered_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">bflag</span><span class="p">[</span><span class="s2">&quot;particle_influence&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">corr_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">addbflag</span><span class="p">[</span><span class="s1">&#39;low_snr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">cr_ldr</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">13</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cr_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">addbflag</span><span class="p">[</span><span class="s1">&#39;plankton&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">addbflag</span><span class="p">[</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_moments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> 
                <span class="ow">or</span> <span class="n">bins_above_noise</span> <span class="o">&gt;</span> <span class="mi">140</span> 
                <span class="ow">or</span> <span class="n">bin_max_span</span> <span class="o">&gt;</span> <span class="mi">180</span>
                <span class="ow">or</span> <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;hs_higher_noise&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">addbflag</span><span class="p">[</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">addbflag</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flag_doc</span></div>


<div class="viewcode-block" id="get_index"><a class="viewcode-back" href="../api_doc.html#spectra_mole.get_index">[docs]</a><span class="k">def</span> <span class="nf">get_index</span><span class="p">(</span><span class="n">grid_mids</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get the index of a value in an array</span>

<span class="sd">    Args:</span>
<span class="sd">        grid_mids: array of grid centers</span>
<span class="sd">        value: array of values</span>
<span class="sd">    Returns:</span>
<span class="sd">        indices        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">grid_mids</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">grid_mids</span><span class="o">-</span><span class="n">diff</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">grid_mids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">diff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1">#print(edges)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">ind</span><span class="p">[</span><span class="n">ind</span> <span class="o">&gt;</span> <span class="n">grid_mids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_mids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">ind</span></div>


<span class="c1">#@profile</span>
<div class="viewcode-block" id="estimate_error"><a class="viewcode-back" href="../api_doc.html#spectra_mole.estimate_error">[docs]</a><span class="k">def</span> <span class="nf">estimate_error</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">separation</span><span class="p">,</span> <span class="n">contrast</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;estimate the error for given separation and contrast form Monte Carlo simulation</span>

<span class="sd">    Args:</span>
<span class="sd">        method: ``diff`` of ``fit``</span>
<span class="sd">        separation: array of separations</span>
<span class="sd">        contrast: array of separations</span>
<span class="sd">    Returns:</span>
<span class="sd">        array of estimated error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loaded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;data/results_2D_</span><span class="si">{}</span><span class="s1">_statistics.npz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
    <span class="c1">#print(loaded.keys())</span>
    <span class="n">index_sep</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">loaded</span><span class="p">[</span><span class="s1">&#39;separation&#39;</span><span class="p">],</span> <span class="n">separation</span><span class="p">)</span>
    <span class="n">index_con</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">loaded</span><span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">],</span> <span class="n">contrast</span><span class="p">)</span>
    <span class="n">est_error_2D</span> <span class="o">=</span> <span class="n">loaded</span><span class="p">[</span><span class="s1">&#39;mean_error&#39;</span><span class="p">][</span><span class="n">index_sep</span><span class="p">,</span> <span class="n">index_con</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">est_error_2D</span></div>



<div class="viewcode-block" id="calc_separation"><a class="viewcode-back" href="../api_doc.html#spectra_mole.calc_separation">[docs]</a><span class="k">def</span> <span class="nf">calc_separation</span><span class="p">(</span><span class="n">bragg_mom</span><span class="p">,</span> <span class="n">moments_broad</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        bragg_mom: moments of the Bragg peak</span>
<span class="sd">        moments_broad: moments of the (adapted to RWP sampling) cloud radar peak</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bragg_mom</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">moments_broad</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">moments_broad</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">bragg_mom</span><span class="o">.</span><span class="n">width</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">input_vals</span> <span class="o">&lt;</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">input_vals</span><span class="p">)):</span>
        <span class="n">separation</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">separation</span> <span class="o">=</span> <span class="p">(</span><span class="n">bragg_mom</span><span class="o">.</span><span class="n">v</span> <span class="o">-</span> <span class="n">moments_broad</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">moments_broad</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">bragg_mom</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">separation</span></div>


<div class="viewcode-block" id="calc_contrast"><a class="viewcode-back" href="../api_doc.html#spectra_mole.calc_contrast">[docs]</a><span class="k">def</span> <span class="nf">calc_contrast</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        spec_corr (dict): Bragg only spectrum</span>
<span class="sd">        spec_broad (dict): spectra dict of cloud radar </span>
<span class="sd">            adapted to rwp sampling characteristics</span>
<span class="sd">        v (float): velocity at which the contrast is evlauated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spec_corr</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">index_vel</span><span class="p">])</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="n">index_vel</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">contrast</span></div>


<div class="viewcode-block" id="bflag2str"><a class="viewcode-back" href="../api_doc.html#spectra_mole.bflag2str">[docs]</a><span class="k">def</span> <span class="nf">bflag2str</span><span class="p">(</span><span class="n">bflag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        bflag (dict): binary flag</span>
<span class="sd">    Returns:</span>
<span class="sd">        flag as binary string, keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#print(&quot;flag keys &quot;, bflag.keys())</span>
    <span class="c1">#[&#39;plankton&#39;, &#39;small_Z_diff&#39;, &#39;melting_layer&#39;, &#39;too_many_peaks&#39;]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mod_calibration&#39;</span><span class="p">,</span> <span class="s1">&#39;unsecure_calibration&#39;</span><span class="p">,</span> <span class="s1">&#39;particle_influence&#39;</span><span class="p">,</span>
            <span class="s1">&#39;removed_moments&#39;</span><span class="p">,</span> <span class="s1">&#39;melting_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;plankton&#39;</span><span class="p">,</span> <span class="s1">&#39;low_snr&#39;</span><span class="p">,</span> <span class="s1">&#39;hs_higher_noise&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bflag</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">bflag</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-1&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">keys</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="bin2int"><a class="viewcode-back" href="../api_doc.html#spectra_mole.bin2int">[docs]</a><span class="k">def</span> <span class="nf">bin2int</span><span class="p">(</span><span class="nb">bin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;convert the binary (as string) to integer&quot;&quot;&quot;</span>
    <span class="c1">#print(&#39;bin conversion&#39;, bin, int(bin, 2))</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<span class="c1">#@profile</span>
<div class="viewcode-block" id="correct_pixel"><a class="viewcode-back" href="../api_doc.html#spectra_mole.correct_pixel">[docs]</a><span class="k">def</span> <span class="nf">correct_pixel</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">rwp</span><span class="p">,</span> <span class="n">advect</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">,</span> <span class="n">sel_range</span><span class="p">,</span> <span class="n">visualize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;do the correction for a single pixel</span>

<span class="sd">    Args:</span>
<span class="sd">        cr: cloud radar handler</span>
<span class="sd">        rwp: radar wind profiler handler</span>
<span class="sd">        advect: advection handler</span>
<span class="sd">        sel_ts (tuple or float): either value or (index, value)</span>
<span class="sd">        sel_range (tuple or float): either value or (index, value)</span>
<span class="sd">        visualize (bool, optional): plot the single spectrum</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict with estimated values</span>


<span class="sd">    ====================  ===============================================================</span>
<span class="sd">     Key                  Example                            </span>
<span class="sd">    ====================  ===============================================================</span>
<span class="sd">     ``bragg_weighting``  vertical velocity estimated with the weighting method                                                      </span>
<span class="sd">     ``bragg_fit``        vertical velocity estimated with the fit method</span>
<span class="sd">     ``spec_rwp``         spectra dict of the radar wind profiler</span>
<span class="sd">     ``spec_broad``       spectra dict of the cloud radar (adapted to rwp)</span>
<span class="sd">     ``flag``             integer flag</span>
<span class="sd">     ``bflag``            binary flag (dict)</span>
<span class="sd">     ``metrics``          separation and contrast</span>
<span class="sd">     ``cal_const``        used calibration constant</span>
<span class="sd">     ``cal_corr``         correct calibration by</span>
<span class="sd">    ====================  ===============================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bflag</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_range</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="n">it</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="n">sel_ts</span>
        <span class="n">ir</span><span class="p">,</span> <span class="n">rg</span> <span class="o">=</span> <span class="n">sel_range</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">sel_ts</span>
        <span class="n">rg</span> <span class="o">=</span> <span class="n">sel_range</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pixel at </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">rg</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pixel at </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">ts</span><span class="p">),</span> <span class="n">rg</span><span class="p">))</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">get_spectrum</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">rg</span><span class="p">,</span> <span class="n">range_average</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spec_rwp</span> <span class="o">=</span> <span class="n">rwp</span><span class="o">.</span><span class="n">get_spectrum</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">,</span> <span class="n">sel_range</span><span class="p">,</span>
                                <span class="n">interp_vel</span><span class="o">=</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">])</span>
    <span class="n">vis</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">([</span><span class="n">spec</span><span class="p">,</span> <span class="n">spec_rwp</span><span class="p">])</span> <span class="k">if</span> <span class="n">visualize</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1">#vis.plot_spectrum(spec, spectrum_rwp=spec_rwp)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]),</span> <span class="s1">&#39;vel lists not identical&#39;</span>
    <span class="n">check_consistency</span><span class="p">([</span><span class="n">spec</span><span class="p">,</span> <span class="n">spec_rwp</span><span class="p">])</span>

    <span class="c1"># load the advection speed</span>
    <span class="n">adv_tupel</span> <span class="o">=</span> <span class="n">advect</span><span class="o">.</span><span class="n">get_pixel</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">rg</span><span class="p">)</span>

    <span class="n">spec_broad</span> <span class="o">=</span> <span class="n">broaden_spectrum</span><span class="p">(</span><span class="n">adv_tupel</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> 
                            <span class="c1"># capture the case where the cr noise thres is larger than the rwp</span>
                            <span class="n">cut_thres</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]))</span>
    <span class="c1">#vis.plot_spectrum(spec, spectrum_rwp=spec_rwp, spectrum_b=spec_broad)</span>
    <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_moments</span><span class="p">(</span><span class="n">spec_broad</span><span class="p">)</span>

    <span class="c1"># system parameter and calibration</span>
    <span class="n">cal_const</span> <span class="o">=</span> <span class="n">estimate_calibration</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">)</span>
    <span class="n">flg</span><span class="p">,</span> <span class="n">cal_corr</span> <span class="o">=</span> <span class="n">check_rwp_calibration</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">)</span>
    <span class="n">bflag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flg</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;mod_calibration&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">spec_rwp</span> <span class="o">=</span> <span class="n">modify_calibration</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">cal_corr</span><span class="p">)</span>
    <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_moments</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;spec_rwp[moments] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mom2str</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]))</span>

    <span class="n">bflag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">check_particle_influence</span><span class="p">(</span><span class="n">spec_broad</span><span class="p">,</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">]))</span>

    <span class="n">spec_rwp</span><span class="p">,</span> <span class="n">flg</span> <span class="o">=</span> <span class="n">check_noise_level</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">extern</span><span class="o">=</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;noise_thres&#39;</span><span class="p">])</span>
    <span class="c1">#spec_rwp, flg = check_noise_level(spec_rwp)</span>
    <span class="n">bflag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flg</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;bflag </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bflag</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bflag</span><span class="p">[</span><span class="s1">&#39;particle_influence&#39;</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;particle influence true&#39;</span><span class="p">)</span>
        <span class="c1"># two ways of correcting</span>
        <span class="c1"># 1. williams</span>
        <span class="n">rwp_weighting</span> <span class="o">=</span> <span class="n">correct_with_weighting</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">)</span>
        <span class="n">rwp_weighting</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_moments</span><span class="p">(</span><span class="n">rwp_weighting</span><span class="p">)</span>

        <span class="c1">#vis.plot_spectrum(spec, spectrum_rwp=spec_rwp, spectrum_b=rwp_weighting)</span>

        <span class="c1"># 2. fuzzy/peakfitting</span>
        <span class="n">rwp_fuzzy</span> <span class="o">=</span> <span class="n">correct_with_fuzzy</span><span class="p">(</span><span class="n">spec_rwp</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">)</span>
        <span class="n">rwp_fuzzy</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_moments</span><span class="p">(</span><span class="n">rwp_fuzzy</span><span class="p">)</span>
        <span class="n">rwp_fit</span> <span class="o">=</span> <span class="n">fit_peak</span><span class="p">(</span><span class="n">rwp_fuzzy</span><span class="p">,</span> <span class="n">rwp_fuzzy</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">])</span>

        <span class="c1"># filter moments</span>
        <span class="n">bounds_unfiltered_moments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mom</span><span class="o">.</span><span class="n">ileft</span><span class="p">,</span> <span class="n">mom</span><span class="o">.</span><span class="n">iright</span><span class="p">)</span> <span class="k">for</span> <span class="n">mom</span> <span class="ow">in</span> <span class="n">rwp_weighting</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]]</span>
        <span class="n">filtered_moments</span><span class="p">,</span> <span class="n">flg</span> <span class="o">=</span> <span class="n">filter_moments</span><span class="p">(</span><span class="n">rwp_weighting</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">],</span> 
                                               <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                               <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iright</span><span class="p">)</span>
        <span class="n">bflag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flg</span><span class="p">)</span>
        <span class="n">rwp_weighting</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_moments</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;filtered moments </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mom2str</span><span class="p">(</span><span class="n">filtered_moments</span><span class="p">))</span>

        <span class="n">flg</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">flag_doc</span> <span class="o">=</span> <span class="n">estimate_flag</span><span class="p">(</span><span class="n">bflag</span><span class="p">,</span> <span class="n">filtered_moments</span><span class="p">,</span>
                                            <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;est_ldr&#39;</span><span class="p">],</span>
                                            <span class="n">bounds_unfiltered_moments</span><span class="p">)</span>
        <span class="n">bflag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">flg</span><span class="p">)</span>


        <span class="n">savepath</span> <span class="o">=</span> <span class="s1">&#39;../plots/</span><span class="si">{}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">))</span>
        <span class="n">vis</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">spec</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">,</span> <span class="n">rwp_weighting</span><span class="p">,</span> <span class="n">rwp_fuzzy</span><span class="p">,</span> <span class="n">spec_rwp</span><span class="p">,</span> <span class="n">rwp_fit</span><span class="p">],</span> 
            <span class="n">further_text</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;flag&#39;</span><span class="p">:</span> <span class="n">flag</span><span class="p">,</span> <span class="s1">&#39;bflag&#39;</span><span class="p">:</span> <span class="n">bflag2str</span><span class="p">(</span><span class="n">bflag</span><span class="p">)[</span><span class="mi">0</span><span class="p">]},</span>
            <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">)</span> <span class="k">if</span> <span class="n">visualize</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_separation</span><span class="p">(</span><span class="n">filtered_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spec_broad</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                   <span class="n">calc_contrast</span><span class="p">(</span><span class="n">rwp_weighting</span><span class="p">,</span> <span class="n">spec_broad</span><span class="p">,</span> <span class="n">filtered_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;metrics separation, contrast </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
        
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bragg_weighting&#39;</span><span class="p">:</span> <span class="n">filtered_moments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;bragg_fit&#39;</span><span class="p">:</span> <span class="n">rwp_fit</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
               <span class="s1">&#39;spec_rwp&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">,</span> <span class="s1">&#39;spec_broad&#39;</span><span class="p">:</span> <span class="n">spec_broad</span><span class="p">,</span>
               <span class="s1">&#39;flag&#39;</span><span class="p">:</span> <span class="n">flag</span><span class="p">,</span><span class="s1">&#39;bflag&#39;</span><span class="p">:</span> <span class="n">bflag</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span> <span class="s1">&#39;flag_doc&#39;</span><span class="p">:</span> <span class="n">flag_doc</span><span class="p">,</span>
               <span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="n">cal_const</span><span class="p">,</span> <span class="s1">&#39;cal_corr&#39;</span><span class="p">:</span> <span class="n">cal_corr</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no particle influence&#39;</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="o">-</span><span class="mi">200</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bragg_weighting&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;bragg_fit&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
               <span class="s1">&#39;spec_rwp&#39;</span><span class="p">:</span> <span class="n">spec_rwp</span><span class="p">,</span> <span class="s1">&#39;spec_broad&#39;</span><span class="p">:</span> <span class="n">spec_broad</span><span class="p">,</span>
               <span class="s1">&#39;flag&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span><span class="s1">&#39;bflag&#39;</span><span class="p">:</span> <span class="n">bflag</span><span class="p">,</span> <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span> 
               <span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="n">cal_const</span><span class="p">,</span> <span class="s1">&#39;cal_corr&#39;</span><span class="p">:</span> <span class="n">cal_corr</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="mira"><a class="viewcode-back" href="../api_doc.html#spectra_mole.mira">[docs]</a><span class="k">class</span> <span class="nc">mira</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;handles cloud radar spectra</span>

<span class="sd">    Args:</span>
<span class="sd">        files (dict): filenames for spectral, cloudnet and mmclx</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---- cloud radar ---------------------------------------------------&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;cr&quot;</span>  <span class="c1"># system type for plot routine</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atten</span> <span class="o">=</span> <span class="n">attenuation</span><span class="o">.</span><span class="n">cloudnet_attenuation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;cloudnet&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">][:]</span>
        <span class="c1"># for some reason the velocity list is not sorted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="c1"># correct an offset estimated by plots (comparison with wp)</span>
        <span class="c1"># self.time_list = self.time_list-30.</span>
        <span class="c1"># for colrawi 2 an offset of 15sec is assumed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span> <span class="o">-</span> <span class="mi">15</span>
        <span class="c1"># self.range_list = f.variables[&quot;range&quot;][:]</span>
        <span class="c1"># compute mean steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span> <span class="o">-</span> <span class="mf">28.78</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;delta h too much off&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;load cloud radar file &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;velocity, range, time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">Description</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time range &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
              <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span>
              <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;height range &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;height resolution [m]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time resolution [s]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;velocity resolution [m/s]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;mmclx&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_list_mmclx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_list_mmclx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">][:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;decoupling&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                         <span class="s1">&#39;thres_factor_co&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
                         <span class="s1">&#39;thres_factor_cx&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">}</span>


    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;close file when object is deleted, sort of an evil hack (mmap, with statement...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="mira.get_profile"><a class="viewcode-back" href="../api_doc.html#spectra_mole.mira.get_profile">[docs]</a>    <span class="k">def</span> <span class="nf">get_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;get the mmclx velocity profile</span>

<span class="sd">        .. warning:: currently using Zg, RMSg togehter with VEL</span>

<span class="sd">        Args:</span>
<span class="sd">            it: time index</span>
<span class="sd">            ir (tuple, optional): range indices, default full profile</span>
<span class="sd">        Returns:</span>
<span class="sd">            vel, Z, width        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;VEL&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ir</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Zg&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ir</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;RMSg&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">ir</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vel</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">width</span></div>

    <span class="c1">#@profile</span>
<div class="viewcode-block" id="mira.get_spectrum"><a class="viewcode-back" href="../api_doc.html#spectra_mole.mira.get_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">,</span> <span class="n">sel_range</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">range_average</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            sel_ts (float or tuple): either timestamp or (it, timestamp)</span>
<span class="sd">            sel_range (float or tuple): either range or (ir, range)</span>
<span class="sd">            silent (bool, optional): printing diagnostics</span>
<span class="sd">            range_average (bool, optional): range average to adapt for the</span>
<span class="sd">                rwp range gate</span>
<span class="sd">        Returns:</span>
<span class="sd">            spectrum dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sel ts </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_range</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">it</span><span class="p">,</span> <span class="n">sel_ts</span> <span class="o">=</span> <span class="n">sel_ts</span>
            <span class="n">ir</span><span class="p">,</span> <span class="n">sel_range</span> <span class="o">=</span> <span class="n">sel_range</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># it = np.where(self.time_list == min(self.time_list, key=lambda t: abs(sel_ts - t)))[0][0]</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">argnearest2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">)</span>
            <span class="c1"># ir = np.where(self.range_list == min(self.range_list, key=lambda t: abs(sel_range - t)))[0][0]</span>
            <span class="n">ir</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">argnearest2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span> <span class="n">sel_range</span><span class="p">)</span>
        <span class="c1"># itm = np.where(self.time_list_mmclx == min(self.time_list_mmclx, key=lambda t: abs(sel_ts - t)))[0][0]</span>
        <span class="n">itm</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">argnearest2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list_mmclx</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sel_ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> \
                <span class="s1">&#39;timestamps (spec) more than </span><span class="si">{}</span><span class="s1">s apart, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sel_ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list_mmclx</span><span class="p">[</span><span class="n">itm</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> \
                <span class="s1">&#39;timestamps (mmclx) more than </span><span class="si">{}</span><span class="s1">s apart, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list_mmclx</span><span class="p">[</span><span class="n">it</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list_mmclx</span><span class="p">[</span><span class="n">itm</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span>\
                 <span class="s1">&#39;timestamps (spec-mmclx) more than </span><span class="si">{}</span><span class="s1">s apart, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">]),</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list_mmclx</span><span class="p">[</span><span class="n">itm</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cloud radar indexes it </span><span class="si">%s</span><span class="s1"> itm </span><span class="si">%s</span><span class="s1"> it </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">itm</span><span class="p">,</span> <span class="n">ir</span><span class="p">)</span>

        <span class="n">gas_atten</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atten</span><span class="o">.</span><span class="n">get_pixel</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">,</span> <span class="n">sel_range</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">range_average</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
            <span class="n">window</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">specZ_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">][:,</span> <span class="n">ir</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">ir</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span>
            <span class="n">specZ_mask</span> <span class="o">=</span> <span class="n">specZ_region</span> <span class="o">==</span> <span class="mf">0.</span>
            <span class="n">specZ_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">specZ_region</span><span class="p">[</span><span class="o">~</span><span class="n">specZ_mask</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">specZ_mask</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-25</span>
            <span class="n">specZ_region</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specZ_region</span><span class="p">,</span> <span class="n">specZ_mask</span><span class="p">,</span> <span class="n">specZ_min</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">specZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">specZ_region</span><span class="p">[:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">specZ_mask</span> <span class="o">=</span> <span class="n">specZ</span> <span class="o">&lt;</span> <span class="n">specZ_min</span><span class="o">*</span><span class="mf">1.0</span>
            <span class="n">specZ</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specZ</span><span class="p">,</span> <span class="n">specZ_mask</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="n">specSNRco_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;SNRco&quot;</span><span class="p">][:,</span> <span class="n">ir</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">ir</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span>
            <span class="n">specSNRco_mask</span> <span class="o">=</span> <span class="n">specSNRco_region</span> <span class="o">==</span> <span class="mf">0.</span>
            <span class="n">specSNRco_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">specSNRco_region</span><span class="p">[</span><span class="o">~</span><span class="n">specSNRco_mask</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">specSNRco_mask</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-25</span>
            <span class="c1"># specSNRco_region = h.fill_with(specSNRco_region, specSNRco_mask, specSNRco_min*0.9)</span>
            <span class="n">specSNRco</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specSNRco_region</span><span class="p">,</span> <span class="n">specSNRco_mask</span><span class="p">,</span> <span class="n">specSNRco_min</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)[:],</span>
                                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">specSNRco_mask</span> <span class="o">=</span> <span class="n">specSNRco</span> <span class="o">&lt;</span> <span class="n">specSNRco_min</span><span class="o">*</span><span class="mf">1.0</span>
            <span class="n">specSNRco</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specSNRco</span><span class="p">,</span> <span class="n">specSNRco_mask</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="n">specSNRcx_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;LDR&quot;</span><span class="p">][:,</span> <span class="n">ir</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">ir</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">it</span><span class="p">]</span> <span class="o">*</span> <span class="n">specSNRco_region</span>
            <span class="n">specSNRcx_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">specSNRcx_region</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">specSNRcx_region</span><span class="p">))</span>
            <span class="n">specSNRcx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">specSNRcx_region</span><span class="p">[</span><span class="o">~</span><span class="n">specSNRcx_mask</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">specSNRcx_mask</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1e-25</span>
            <span class="n">specSNRcx_region</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specSNRcx_region</span><span class="p">,</span> <span class="n">specSNRcx_mask</span><span class="p">,</span> <span class="n">specSNRcx_min</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">specSNRcx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">specSNRcx_region</span><span class="p">[:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
            <span class="n">specSNRcx_mask</span> <span class="o">=</span> <span class="n">specSNRcx</span> <span class="o">&lt;</span> <span class="n">specSNRcx_min</span><span class="o">*</span><span class="mf">1.0</span>
            <span class="n">specSNRcx</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specSNRcx</span><span class="p">,</span> <span class="n">specSNRcx_mask</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

            <span class="n">specLDR</span> <span class="o">=</span> <span class="n">specSNRcx</span><span class="o">/</span><span class="n">specSNRco</span>
            <span class="n">specLDR_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">specSNRcx_mask</span><span class="p">,</span> <span class="n">specSNRco_mask</span><span class="p">)</span>
            <span class="n">specLDR</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">specLDR</span><span class="p">,</span> <span class="n">specLDR_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">specZ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][:,</span><span class="n">ir</span><span class="p">,</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">specZ_mask</span> <span class="o">=</span> <span class="n">specZ</span> <span class="o">==</span> <span class="mf">0.</span>
            <span class="c1">#print(&#39;specZ.shape&#39;, specZ.shape, specZ)</span>
            <span class="n">specLDR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;LDR&#39;</span><span class="p">][:,</span><span class="n">ir</span><span class="p">,</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">specLDR_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">specLDR</span><span class="p">)</span>
            <span class="n">specSNRco</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspec</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;SNRco&#39;</span><span class="p">][:,</span><span class="n">ir</span><span class="p">,</span><span class="n">it</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">specSNRco_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">specSNRco</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="c1">#specSNRco = np.ma.masked_equal(specSNRco, 0)</span>

        <span class="n">specZ</span> <span class="o">=</span> <span class="n">specZ</span><span class="o">*</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">gas_atten</span><span class="p">)</span>
        <span class="n">noise_thres</span> <span class="o">=</span> <span class="mf">1e-25</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">specZ_mask</span><span class="p">)</span> <span class="k">else</span> <span class="n">specZ</span><span class="p">[</span><span class="o">~</span><span class="n">specZ_mask</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;thres_factor_co&#39;</span><span class="p">])</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">ir</span><span class="p">],</span> <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">,</span>
                    <span class="s1">&#39;specZ&#39;</span><span class="p">:</span> <span class="n">specZ</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;noise_thres&#39;</span><span class="p">:</span> <span class="n">noise_thres</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">}</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specZ_mask</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specSNRco</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specSNRco_mask</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specLDR</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">specLDR_mask</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZcx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR&#39;</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZcx_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR_mask&#39;</span><span class="p">])</span>
        <span class="c1"># print(&#39;test specZcx calc&#39;)</span>
        <span class="c1"># print(spectrum[&#39;specZcx_mask&#39;])</span>
        <span class="n">ldr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;specZcx&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR_mask&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR_mask&#39;</span><span class="p">]])</span>
        <span class="c1">#print(&quot;LDR/ICPR &quot;, ldr, h.lin2z(ldr))</span>
        <span class="c1">#print(&quot;LDR_corr &quot;, h.lin2z(ldr - 0.0032))        </span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR&#39;</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco_mask&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDR_mask&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">]):</span>
            <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;minSNRcx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-99</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;minSNRcx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">thresSNRcx</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;minSNRcx&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;thres_factor_cx&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">]):</span>
            <span class="n">minSNRco</span> <span class="o">=</span> <span class="mf">1e-99</span>
            <span class="n">thresSNRco</span> <span class="o">=</span> <span class="mf">1e-99</span>
            <span class="n">thresdecoup</span> <span class="o">=</span> <span class="mf">1e-99</span>
            <span class="c1"># maxSNRco = 1e-99</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minSNRco</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco_mask&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">thresSNRco</span> <span class="o">=</span> <span class="n">minSNRco</span><span class="o">*</span><span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;thres_factor_co&#39;</span><span class="p">])</span>
            <span class="n">thresdecoup</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">])</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;decoupling&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="c1"># maxSNRco = minSNRco*h.z2lin(self.settings[&#39;decoupling&#39;])</span>

        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco_mask&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresSNRco</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">],</span> 
                                                    <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">],</span> <span class="mf">1e-30</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thresSNRcx</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx_mask&#39;</span><span class="p">],</span> 
                                                    <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx_mask&#39;</span><span class="p">],</span> <span class="mf">1e-30</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thresdecoup</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx_mask&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco_mask&#39;</span><span class="p">])</span>
        
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRcx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx&#39;</span><span class="p">][</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx_mask&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco&#39;</span><span class="p">][</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco_mask&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco&#39;</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRcx_mask&#39;</span><span class="p">],</span> <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;validSNRco_mask&#39;</span><span class="p">])</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked&#39;</span><span class="p">][</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specLDRmasked_mask&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;decoupling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;decoupling&#39;</span><span class="p">]</span>
        <span class="c1"># and the bulk properties from the mmclx file</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;est_meanvel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;VELg&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;est_width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;RMSg&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;est_ldr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmmclx</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;LDRg&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">])</span>

        <span class="c1">#print(&#39;mira spectrum keys&#39;, spectrum.keys())</span>
        <span class="k">return</span> <span class="n">spectrum</span></div></div>


<div class="viewcode-block" id="rwp"><a class="viewcode-back" href="../api_doc.html#spectra_mole.rwp">[docs]</a><span class="k">class</span> <span class="nc">rwp</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        files (dict): filename for rwp</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---- wind profiler -------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;rwp&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1"># prevent the automatic use of fill-value-masking</span>
        <span class="c1"># (meaning a strange conversion from string to float...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">set_auto_maskandscale</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;rwp&quot;</span>  <span class="c1"># system type for plot routine</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># loading whole data at once seems to be a very bad idea</span>
        <span class="c1"># self.spectra = self.f.variables[&quot;Spectra&quot;]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_snr_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;SNR&quot;</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_snr_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_snr_arr</span><span class="p">,</span> <span class="mf">3.00e+38</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;MeanDopplerVelocity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.</span><span class="p">)</span>
        <span class="c1"># noise level in db; dimensions (Time, Heights)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noiselevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;NoiseLevel&quot;</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noiselevel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">,</span> <span class="mf">3.00e+38</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">][:]</span>
        <span class="c1"># compute mean timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">))</span>
        <span class="c1"># build height index</span>
        <span class="c1"># self.delta_h = f.variables[&quot;HeightSpacing&quot;][0]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;HeightSpacing&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span> <span class="o">-</span> <span class="mf">93.997</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;Height spacing wrong&quot;</span>
        <span class="c1"># correct offset estimated by plots (comparison with cr); half a rangegate: 46.9985</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span> <span class="o">+</span> <span class="p">(</span><span class="mf">448.3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
             <span class="c1"># [i*self.delta_h + (448.0+46.9985)</span>
             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Gates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])])</span>
        <span class="c1">#print(&quot;range list &quot;, self.range_list.shape, self.range_list)</span>
        <span class="c1"># 0m/s bin left or right of array center???</span>
        <span class="c1"># Nyquist frequency in both directions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;NyquistFrequency&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">256.</span>
        <span class="c1"># now the zero bin is right of center?</span>

        <span class="c1">#self.vel_list = np.array([i * self.delta_v for i in range(-255, 257)]) - 0.5 * self.delta_v  # correct vel_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_v</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">255</span><span class="p">,</span> <span class="mi">257</span><span class="p">)])</span> <span class="c1"># correct vel_list</span>
        <span class="c1"># self.vel_list = np.array([i*self.delta_v for i in range(-255, 257)])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# vel as calculated &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">[</span><span class="mi">254</span><span class="p">:</span><span class="mi">257</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;load wind profiler file &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;rwp&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;wipro time range &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
              <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span>
              <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;height range &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;height resolution [m]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time resolution [s]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;velocity resolution [m/s]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_v</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spectra array dimensions &quot;</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Spectra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Spectra&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nyquist frequency [m/s] &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;NyquistFrequency&quot;</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span>
        <span class="c1"># print(&quot;spectra units &quot;, f.variables[&quot;Spectra&quot;].units)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="mf">1.45e-15</span><span class="p">,</span>
                         <span class="s1">&#39;thres_factor&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;close file when object is deleted, sort of an evil hack (mmap, with statement...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#@profile</span>
<div class="viewcode-block" id="rwp.get_spectrum"><a class="viewcode-back" href="../api_doc.html#spectra_mole.rwp.get_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">,</span> <span class="n">sel_range</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp_vel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cal_corr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return a single spectrum</span>

<span class="sd">        .. warning:: rwp spectrum is smoothed with a gaussian shaped running window</span>

<span class="sd">        Args:</span>
<span class="sd">            sel_ts (float or tuple): either timestamp or (it, timestamp)</span>
<span class="sd">            sel_range (float or tuple): either range or (ir, range)</span>
<span class="sd">            silent (bool, optional): printing diagnostics</span>
<span class="sd">            interp_vel (bool, optional): velocity array to interpolate</span>

<span class="sd">        Returns:</span>
<span class="sd">            spectrum dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">sel_range</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">it</span><span class="p">,</span> <span class="n">sel_ts</span> <span class="o">=</span> <span class="n">sel_ts</span>
            <span class="n">ir</span><span class="p">,</span> <span class="n">sel_range</span> <span class="o">=</span> <span class="n">sel_range</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sel_ts</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sel_range</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sel_ts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span>\
                 <span class="s1">&#39;timestamps (rwp) more than </span><span class="si">{}</span><span class="s1">s apart, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">sel_ts</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;selected it </span><span class="si">%s</span><span class="s1">, ir </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">)</span>

        <span class="c1">#ntime = nearest(sel_timestamp, self.time_list, self.delta_t)</span>
        <span class="c1">#nheight = nearest(sel_height, self.range_list, self.delta_h)</span>

        <span class="n">spectra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;Spectra&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">,</span> <span class="p">:</span><span class="mi">512</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">est_meanvel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanvelocity</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">]</span>
        <span class="n">noise_lvl</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiselevel</span><span class="p">[</span><span class="n">it</span><span class="p">,</span> <span class="n">ir</span><span class="p">])</span>
        <span class="c1"># noise level from measurement</span>
        <span class="c1"># calculate signal for system parameter estimation</span>
        <span class="n">raw_spectra</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">raw_spectra</span><span class="p">[</span><span class="n">raw_spectra</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;thres_factor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">noise_lvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_lvl</span>
        <span class="c1">#total_signal = np.sum(spectra - noise_lvl)</span>

        <span class="c1"># &quot;calibrated&quot; spectrum (should give the reflectivity in Ze)</span>
        <span class="n">snrspectrum</span> <span class="o">=</span> <span class="n">spectra</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#spectrum[spectrum &lt; self.settings[&#39;thres_factor&#39;] * noise_lvl] = noise_lvl</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cal_corr</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cal_corr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">cal_corr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">z2lin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;# systemparameter </span><span class="si">%s</span><span class="s2"> corr </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span><span class="p">,</span> <span class="n">cal_corr</span><span class="p">)</span>

        <span class="n">zspectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">snrspectrum</span>
        <span class="n">convol_kernel</span> <span class="o">=</span> <span class="n">gauss_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># we have to keep the convolution for the gaussian, because sum is not 0</span>
        <span class="n">convol_kernel</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">convol_kernel</span><span class="p">)</span>
        <span class="n">zspectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">zspectrum</span><span class="p">,</span> <span class="n">convol_kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">snrspectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">snrspectrum</span><span class="p">,</span> <span class="n">convol_kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>

        <span class="c1"># calibrated noise threshold and level</span>
        <span class="n">noise_thres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;thres_factor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">noise_lvl</span>
        <span class="n">noise_lvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_lvl</span>

        <span class="n">spectrum</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">ir</span><span class="p">],</span> <span class="s1">&#39;vel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">,</span>
                    <span class="s1">&#39;delta_v&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_v</span><span class="p">,</span>
                    <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">}</span>
        <span class="c1"># interpolation of the spectrum</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">interp_vel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">wp_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">,</span>
                                                   <span class="n">zspectrum</span><span class="p">,</span>
                                                   <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">zspectrum</span> <span class="o">=</span> <span class="n">wp_interp</span><span class="p">(</span><span class="n">interp_vel</span><span class="p">)</span>
            <span class="n">wp_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vel_list</span><span class="p">,</span>
                                                   <span class="n">snrspectrum</span><span class="p">,</span>
                                                   <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">snrspectrum</span> <span class="o">=</span> <span class="n">wp_interp</span><span class="p">(</span><span class="n">interp_vel</span><span class="p">)</span>
            <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;vel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_vel</span>

        <span class="n">noise_char</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">estimate_noise</span><span class="p">(</span><span class="n">zspectrum</span><span class="p">)</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_char</span><span class="p">[</span><span class="s1">&#39;noise_mean&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;noise comparison </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">noise_lvl</span><span class="p">),</span> <span class="n">h</span><span class="o">.</span><span class="n">lin2z</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;noise_lvl_hs&#39;</span><span class="p">]))</span>

        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specZ_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zspectrum</span> <span class="o">&lt;</span> <span class="n">noise_thres</span>
        <span class="n">spectrum</span><span class="p">[</span><span class="s1">&#39;specSNRco&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snrspectrum</span>
        <span class="c1"># [&#39;specSNRco_mask&#39;, &#39;system&#39;, &#39;ts&#39;, &#39;minSNRcx&#39;, &#39;specLDRmasked_mask&#39;, &#39;validSNRcx&#39;, &#39;specSNRcx&#39;, &#39;specSNRcx_mask&#39;, </span>
        <span class="c1"># &#39;specZ&#39;, &#39;validSNRco_mask&#39;, &#39;specZ_mask&#39;, &#39;decoupling&#39;, &#39;specZcx&#39;, &#39;noise_thres&#39;, &#39;specLDRmasked&#39;, &#39;specLDR&#39;, </span>
        <span class="c1"># &#39;specZcx_mask&#39;, &#39;vel&#39;, &#39;range&#39;, &#39;validSNRco&#39;, &#39;specLDR_mask&#39;, &#39;validSNRcx_mask&#39;, &#39;specSNRco&#39;]</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;specZ&#39;</span><span class="p">:</span> <span class="n">zspectrum</span><span class="p">,</span> <span class="s1">&#39;est_meanvel&#39;</span><span class="p">:</span> <span class="n">est_meanvel</span><span class="p">,</span> <span class="s1">&#39;cal_const&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cal_const</span><span class="p">,</span>
                         <span class="s1">&#39;noise_thres&#39;</span><span class="p">:</span> <span class="n">noise_thres</span><span class="p">,</span> <span class="s1">&#39;noise_lvl&#39;</span><span class="p">:</span> <span class="n">noise_lvl</span><span class="p">,</span>
                         <span class="p">})</span>
        <span class="k">return</span> <span class="n">spectrum</span></div></div>


<div class="viewcode-block" id="mole_output"><a class="viewcode-back" href="../api_doc.html#spectra_mole.mole_output">[docs]</a><span class="k">class</span> <span class="nc">mole_output</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        files (dict): filename for mole</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---- mole -------------------------------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;mole&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;mole&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1"># prevent the automatic use of fill-value-masking</span>
        <span class="c1"># (meaning a strange conversion from string to float...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">set_auto_maskandscale</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="s2">&quot;mole&quot;</span>  <span class="c1"># system type for plot routine</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># loading whole data at once seems to be a very bad idea</span>
        <span class="c1"># self.spectra = self.f.variables[&quot;Spectra&quot;]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">][:]</span>
        <span class="c1"># compute mean timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">))</span>
        <span class="c1"># build height index</span>
        <span class="c1"># self.delta_h = f.variables[&quot;HeightSpacing&quot;][0]</span>
        <span class="c1"># correct offset estimated by plots (comparison with cr); half a rangegate: 46.9985</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">))</span>
        <span class="c1"># 0m/s bin left or right of array center???</span>
        <span class="c1"># Nyquist frequency in both directions</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mole time range &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
              <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span>
              <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;height range &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;height resolution [m]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_h</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        close file when object is deleted, sort of an evil hack (mmap, with statement...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<div class="viewcode-block" id="mole_output.get_interpolated_profile"><a class="viewcode-back" href="../api_doc.html#spectra_mole.mole_output.get_interpolated_profile">[docs]</a>    <span class="k">def</span> <span class="nf">get_interpolated_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">interp_heights</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;load the windprofiler spectrum</span>

<span class="sd">        Args:</span>
<span class="sd">            it (int): index of timestamp</span>
<span class="sd">            interp_heights (array): dersired height grid</span>
<span class="sd">        Returns:</span>
<span class="sd">            profile of velocities, flag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;quality_flag&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
        <span class="c1"># load vel data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vair</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">][</span><span class="n">it</span><span class="p">,:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vair</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vair</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vair</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flag</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vair</span><span class="p">)</span>

        <span class="c1"># interpolate</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vair</span><span class="p">[:])],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">vair</span><span class="p">[:]</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                       <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">interp_values</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">interp_heights</span><span class="p">)</span>

        <span class="c1"># this mask is only for the gaps in the interpolation</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vair</span><span class="p">[:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                                       <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                       <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">interp_mask</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">interp_heights</span><span class="p">)</span>
        <span class="c1">#interp_values = np.ma.masked_where(interp_mask &gt; 0.3, interp_values)</span>
        <span class="n">interp_values</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">fill_with</span><span class="p">(</span><span class="n">interp_values</span><span class="p">,</span> <span class="n">interp_mask</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1">#now we interpolate the true mask</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">range_list</span><span class="p">[:],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">[:]</span><span class="o">.</span><span class="n">compressed</span><span class="p">(),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                       <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">interp_flag</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">interp_heights</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interp_values</span><span class="p">,</span> <span class="n">interp_flag</span></div></div>



<div class="viewcode-block" id="correct_region"><a class="viewcode-back" href="../api_doc.html#spectra_mole.correct_region">[docs]</a><span class="k">def</span> <span class="nf">correct_region</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;run the correction for a specified region</span>

<span class="sd">    Args:</span>
<span class="sd">        bounds (dict): time and height boundaries for this case</span>
<span class="sd">        files (dict): file list for this case</span>
<span class="sd">    Returns:</span>
<span class="sd">        data dict with the results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cr_handler</span> <span class="o">=</span> <span class="n">mira</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">rwp_handler</span> <span class="o">=</span> <span class="n">rwp</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">advect</span> <span class="o">=</span> <span class="n">advection</span><span class="o">.</span><span class="n">cloudnet_advect</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;cloudnet&#39;</span><span class="p">])</span>
    
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;mira_begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># positive is ok</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;mira_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_dt&#39;</span><span class="p">])</span> <span class="c1"># positive is ok</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;rwp_begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># positive is ok</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;rwp_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_dt&#39;</span><span class="p">])</span> <span class="c1"># positive is ok</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">70</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coverage</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="s2">&quot;not enough coverage </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coverage</span><span class="p">))</span>
    
    <span class="n">b_it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b_ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">range_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_rg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">range_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">rwp_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_rg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_it</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">e_ir</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;it &#39;</span><span class="p">,</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">e_it</span><span class="p">,</span> <span class="s1">&#39;ir &#39;</span><span class="p">,</span> <span class="n">b_ir</span><span class="p">,</span> <span class="n">e_ir</span><span class="p">)</span>
    
    <span class="c1"># corrected velocity region</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">e_it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">e_ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">))</span>
    <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">b_it</span><span class="p">:</span><span class="n">e_it</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;range_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">b_ir</span><span class="p">:</span><span class="n">e_ir</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cal_const_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">]</span>
    
    <span class="n">spectra_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">e_ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">)</span>
    <span class="n">spectra_ct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b_it</span><span class="p">,</span> <span class="n">e_it</span><span class="p">):</span>
        <span class="n">sel_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b_ir</span><span class="p">,</span> <span class="n">e_ir</span><span class="p">):</span>
            <span class="n">sel_rg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">rwp_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">ir</span><span class="p">])</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">correct_pixel</span><span class="p">(</span><span class="n">cr_handler</span><span class="p">,</span> <span class="n">rwp_handler</span><span class="p">,</span> <span class="n">advect</span><span class="p">,</span> <span class="n">sel_ts</span><span class="p">,</span> <span class="n">sel_rg</span><span class="p">)</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;flag_doc&#39;</span> <span class="ow">in</span> <span class="n">corr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flag_doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;flag_doc&#39;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bflag&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin2int</span><span class="p">(</span>
                <span class="n">bflag2str</span><span class="p">(</span><span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bflag&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_weight_Z&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bragg_weighting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_weight_v&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bragg_weighting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">v</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_weight_width&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bragg_weighting&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_fit_Z&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bragg_fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_fit_v&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bragg_fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">v</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_fit_width&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;bragg_fit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rwp_raw_Z&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_rwp&#39;</span><span class="p">][</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rwp_raw_vel&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_rwp&#39;</span><span class="p">][</span><span class="s1">&#39;est_meanvel&#39;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rwp_raw_width&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_rwp&#39;</span><span class="p">][</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rwp_raw_noise&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_rwp&#39;</span><span class="p">][</span><span class="s1">&#39;noise_lvl&#39;</span><span class="p">]</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_Z&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_broad&#39;</span><span class="p">][</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Z</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_vel&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_broad&#39;</span><span class="p">][</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">v</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cr_width&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_broad&#39;</span><span class="p">][</span><span class="s1">&#39;moments&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;broadening&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;spec_broad&#39;</span><span class="p">][</span><span class="s1">&#39;sigma_b&#39;</span><span class="p">]</span>
            <span class="c1"># vterm missing</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;separation&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;cal_const&#39;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cal_corr&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s1">&#39;cal_corr&#39;</span><span class="p">]</span>

            
    <span class="c1">#data[&#39;error_weight&#39;] = estimate_error(&#39;diff&#39;, data[&#39;separation&#39;], data[&#39;contrast&#39;])</span>
    <span class="c1">#data[&#39;error_fit&#39;] = estimate_error(&#39;fit&#39;, data[&#39;separation&#39;], data[&#39;contrast&#39;])</span>

    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;error_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimate_error</span><span class="p">(</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;separation&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">])</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;error_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimate_error</span><span class="p">(</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;separation&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;contrast&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;key is ndarray&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;contains nans? &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])))</span>
            <span class="c1">#data[key] = np.ma.masked_invalid(data[key], copy=True)</span>
<span class="c1">#     self.v_term = self.clara.v_reg - np.ma.masked_where(self.flag_region &gt; 3.0, self.corr_vel_reg)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time_list&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_list&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cal_corr&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cal_corr&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bragg_weight_Z&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bragg_weight_Z&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;separation&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;separation&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error fit&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;error_fit&#39;</span><span class="p">])</span>
    <span class="c1">#logger.debug(&#39;done with correction&#39;)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="terminal_region"><a class="viewcode-back" href="../api_doc.html#spectra_mole.terminal_region">[docs]</a><span class="k">def</span> <span class="nf">terminal_region</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculate the terminal velocity for a specified region</span>

<span class="sd">    Args:</span>
<span class="sd">        bounds (dict): time and height boundaries for this case</span>
<span class="sd">        files (dict): file list for this case</span>
<span class="sd">    Returns:</span>
<span class="sd">        data dict with the results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cr_handler</span> <span class="o">=</span> <span class="n">mira</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">mole</span> <span class="o">=</span> <span class="n">mole_output</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;mira_begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># positive is ok</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;mira_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_dt&#39;</span><span class="p">])</span> <span class="c1"># positive is ok</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;mole_begin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">mole</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># positive is ok</span>
    <span class="n">coverage</span><span class="p">[</span><span class="s1">&#39;mole_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_dt&#39;</span><span class="p">])</span> <span class="c1"># positive is ok</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">70</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">coverage</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span> <span class="s2">&quot;not enough coverage </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coverage</span><span class="p">))</span>

    <span class="n">b_it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b_ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">range_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;b_rg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_it</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">dt_to_ts</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_dt&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_ir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">range_list</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;e_rg&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">)))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">e_it</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">e_ir</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;it &#39;</span><span class="p">,</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">e_it</span><span class="p">,</span> <span class="s1">&#39;ir &#39;</span><span class="p">,</span> <span class="n">b_ir</span><span class="p">,</span> <span class="n">e_ir</span><span class="p">)</span>

    <span class="c1"># corrected velocity region</span>
    <span class="c1">#var = np.empty((e_it - b_it, cr_handler.range_list.shape[0]))</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">e_it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="n">e_ir</span> <span class="o">-</span> <span class="n">b_ir</span><span class="p">))</span>
    <span class="n">var</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">b_it</span><span class="p">:</span><span class="n">e_it</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;range_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">b_ir</span><span class="p">:</span><span class="n">e_ir</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flag_doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;quality_flag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">comment</span>

    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">b_it</span><span class="p">,</span> <span class="n">e_it</span><span class="p">):</span>
    <span class="c1">#for it in range(b_it, b_it+10):</span>
        <span class="n">it_mole</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">argnearest2</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">time_list</span><span class="p">,</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;it cr &#39;</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="s1">&#39; mole &#39;</span><span class="p">,</span> <span class="n">it_mole</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;times cr &#39;</span><span class="p">,</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">],</span>  <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">]),</span> 
                 <span class="n">mole</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it_mole</span><span class="p">],</span> <span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">mole</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it_mole</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">-</span> <span class="n">mole</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it_mole</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># mole profile too far away (on time axis) -&gt; mask</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;at </span><span class="si">{}</span><span class="s1"> not fitting mole profile&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ts_to_dt</span><span class="p">(</span><span class="n">cr_handler</span><span class="o">.</span><span class="n">time_list</span><span class="p">[</span><span class="n">it</span><span class="p">])))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">vair</span><span class="p">,</span> <span class="n">flag_air</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">get_interpolated_profile</span><span class="p">(</span><span class="n">it_mole</span><span class="p">,</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">range_list</span><span class="p">[</span><span class="n">b_ir</span><span class="p">:</span><span class="n">e_ir</span><span class="p">])</span>
            <span class="n">vvert</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">cr_handler</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="p">(</span><span class="n">b_ir</span><span class="p">,</span> <span class="n">e_ir</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">vair</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">vvert</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;shapes of the velocity profiles not fitting&quot;</span>

            <span class="n">vterm</span> <span class="o">=</span> <span class="n">vvert</span> <span class="o">-</span> <span class="n">vair</span>
            <span class="c1">#print(vterm.mask[15:25])</span>
            <span class="c1">#print(vterm.mask[-15:])</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;terminal_vel&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vterm</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vertical_vel&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vvert</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;air_vel&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vair</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;quality_flag&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">flag_air</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">][</span><span class="n">it</span> <span class="o">-</span> <span class="n">b_it</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">width</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">mole</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="vm">__dict__</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Martin Radenz, Johannes Bühl

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>